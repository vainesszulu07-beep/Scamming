// server.js
const express = require("express");
const axios = require("axios");
const fs = require("fs");
const path = require("path");

const app = express();
const PORT = 3000;

// MoneyUnify Auth ID
const AUTH_ID = "01K7xxxxxxxxxx"; // <-- replace with your real auth_id

// File to store transactions and balance
const TX_FILE = path.join(__dirname, "transactions.json");

// Middleware
app.use(express.json());
app.use(express.static(path.join(__dirname, "public"))); // serve wallet.html

// Helpers to read/write JSON
function readTransactions() {
  if (!fs.existsSync(TX_FILE)) {
    return { transactions: {}, balance: 0.0 };
  }
  return JSON.parse(fs.readFileSync(TX_FILE, "utf8"));
}

function saveTransactions(data) {
  fs.writeFileSync(TX_FILE, JSON.stringify(data, null, 2));
}

// -----------------------
// PAY: Request a new transaction
// -----------------------
app.post("/pay", async (req, res) => {
  const { phone, amount } = req.body;

  if (!phone || !amount) {
    return res.status(400).json({ error: "Phone and amount required" });
  }

  try {
    // Request payment from MoneyUnify
    const response = await axios.post(
      "https://api.moneyunify.one/payments/request",
      { from_payer: phone, amount, auth_id: AUTH_ID },
      { headers: { "Content-Type": "application/json" } }
    );

    const data = response.data;

    // Save transaction locally
    if (data.transaction_id) {
      const txData = readTransactions();
      txData.transactions[data.transaction_id] = {
        phone,
        amount: parseFloat(amount),
        status: data.status || "pending",
        counted: false,
        created_at: new Date().toISOString()
      };
      saveTransactions(txData);
    }

    // Send back API response so frontend can display it
    res.json(data);
  } catch (err) {
    res.status(500).json({
      error: "Payment request failed",
      details: err.response?.data || err.message
    });
  }
});

// -----------------------
// AUTO-VERIFY PENDING TRANSACTIONS
// -----------------------
async function autoVerifyPending() {
  const txData = readTransactions();
  const transactions = txData.transactions;

  for (const txId in transactions) {
    const tx = transactions[txId];

    // Only verify pending & uncounted transactions
    if (tx.status === "pending" && !tx.counted) {
      try {
        const response = await axios.post(
          "https://api.moneyunify.one/payments/verify",
          { auth_id: AUTH_ID, transaction_id: txId },
          { headers: { "Content-Type": "application/json" } }
        );

        const result = response.data;

        // Update transaction with latest status
        tx.status = result.status || "pending";
        tx.verified_at = new Date().toISOString();

        // Update balance only if successful and not yet counted
        if (tx.status === "successful" && !tx.counted) {
          txData.balance += parseFloat(tx.amount);
          tx.counted = true;
        }

        console.log(`Transaction ${txId} verified: ${tx.status}`);

      } catch (err) {
        console.error(`Failed to verify ${txId}:`, err.message);
      }
    }
  }

  saveTransactions(txData);
}

// Run auto-verification every 5 seconds
setInterval(autoVerifyPending, 5000);

// -----------------------
// GET ALL TRANSACTIONS & BALANCE
// -----------------------
app.get("/transactions", (req, res) => {
  const txData = readTransactions();
  res.json(txData); // returns balance + all transactions
});

// -----------------------
// START SERVER
// -----------------------
app.listen(PORT, () => {
  console.log(`Server running at http://localhost:${PORT}`);
});
