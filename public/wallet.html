<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MoneyUnify Wallet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0f172a;
      color: #e5e7eb;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }

    .wallet {
      background: #020617;
      padding: 20px;
      border-radius: 10px;
      width: 100%;
      max-width: 360px;
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
    }

    h2 {
      text-align: center;
      margin-bottom: 15px;
    }

    input, button {
      width: 100%;
      padding: 12px;
      margin-top: 10px;
      border-radius: 6px;
      border: none;
      font-size: 16px;
    }

    input {
      background: #020617;
      border: 1px solid #334155;
      color: #fff;
    }

    button {
      background: #2563eb;
      color: #fff;
      cursor: pointer;
    }

    button:disabled {
      background: #334155;
      cursor: not-allowed;
    }

    .status {
      margin-top: 15px;
      padding: 10px;
      text-align: center;
      border-radius: 6px;
      font-weight: bold;
    }

    .pending { background: #92400e; }
    .successful { background: #166534; }
    .failed { background: #7f1d1d; }

    .balance {
      font-size: 1.5em;
      margin-top: 10px;
      text-align: center;
    }

    pre {
      background: #020617;
      border: 1px solid #334155;
      padding: 10px;
      margin-top: 10px;
      border-radius: 6px;
      font-size: 12px;
      max-height: 200px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-break: break-word;
    }
  </style>
</head>
<body>

<div class="wallet">
  <h2>MoneyUnify Wallet</h2>

  <div class="balance">Balance: <span id="balance">0.00</span> ZMW</div>

  <input id="phone" placeholder="Phone (e.g 26097xxxxxxx)" />
  <input id="amount" type="number" placeholder="Amount" />

  <button id="payBtn" onclick="pay()">Pay</button>

  <div id="statusBox" class="status" style="display:none;"></div>
  <pre id="verifyBox" style="display:none;"></pre>
</div>

<script>
let poller = null;

function setStatus(text, type) {
  const box = document.getElementById("statusBox");
  box.style.display = "block";
  box.className = "status " + type;
  box.innerText = text;
}

function showVerify(data) {
  const box = document.getElementById("verifyBox");
  box.style.display = "block";
  box.textContent = JSON.stringify(data, null, 2);
}

function updateBalance(balance) {
  document.getElementById("balance").textContent = balance.toFixed(2);
}

async function pay() {
  const phone = document.getElementById("phone").value.trim();
  const amount = document.getElementById("amount").value.trim();
  const btn = document.getElementById("payBtn");

  if (!phone || !amount) {
    alert("Enter phone and amount");
    return;
  }

  btn.disabled = true;
  setStatus("Initiating payment...", "pending");
  document.getElementById("verifyBox").style.display = "none";

  try {
    const res = await fetch("/pay", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ phone, amount })
    });

    const data = await res.json();

    if (!res.ok) {
      btn.disabled = false;
      setStatus("Payment request failed", "failed");
      showVerify(data);
      return;
    }

    setStatus("Payment initiated. Waiting...", "pending");
    showVerify(data);
    startPolling();

  } catch (err) {
    btn.disabled = false;
    setStatus("Network error", "failed");
  }
}

function startPolling() {
  if (poller) clearInterval(poller);

  poller = setInterval(async () => {
    try {
      const res = await fetch("/status");
      const data = await res.json();

      if (!data.status) return;

      // Update status
      setStatus("Status: " + data.status, data.status);

      // Update balance if available
      if (data.balance !== undefined) {
        updateBalance(data.balance);
      }

      // Show verify JSON progress
      if (data.verify_response) {
        showVerify(data.verify_response);
      }

      // Stop polling if final
      if (data.status === "successful" || data.status === "failed") {
        clearInterval(poller);
        document.getElementById("payBtn").disabled = false;
      }

    } catch (err) {
      console.error("Polling error", err);
    }
  }, 3000);
}

// Initialize balance on page load
async function initBalance() {
  try {
    const res = await fetch("/status");
    const data = await res.json();
    if (data.balance !== undefined) updateBalance(data.balance);
  } catch {}
}
initBalance();
</script>

</body>
</html>
